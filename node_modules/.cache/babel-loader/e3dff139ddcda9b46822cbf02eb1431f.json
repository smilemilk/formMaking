{"remainingRequest":"/Users/shanliguo/Documents/workstudy/vue-form-making/node_modules/babel-loader/lib/index.js!/Users/shanliguo/Documents/workstudy/vue-form-making/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/shanliguo/Documents/workstudy/vue-form-making/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/shanliguo/Documents/workstudy/vue-form-making/src/components/Upload/index.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/shanliguo/Documents/workstudy/vue-form-making/src/components/Upload/index.vue","mtime":1557564977000},{"path":"/Users/shanliguo/Documents/workstudy/vue-form-making/package.json","mtime":1557727773054},{"path":"/Users/shanliguo/Documents/workstudy/vue-form-making/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/shanliguo/Documents/workstudy/vue-form-making/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/shanliguo/Documents/workstudy/vue-form-making/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/shanliguo/Documents/workstudy/vue-form-making/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import _objectSpread from \"/Users/shanliguo/Documents/workstudy/vue-form-making/node_modules/@babel/runtime-corejs2/helpers/esm/objectSpread\";\nimport \"core-js/modules/es6.array.find-index\";\nimport \"core-js/modules/es6.number.constructor\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport Viewer from 'viewerjs';\nimport Draggable from 'vuedraggable';\nimport * as qiniu from 'qiniu-js';\n\nrequire('viewerjs/dist/viewer.css');\n\nexport default {\n  components: {\n    Draggable: Draggable\n  },\n  props: {\n    value: {\n      type: Array,\n      default: function _default() {\n        return [];\n      }\n    },\n    width: {\n      type: Number,\n      default: 100\n    },\n    height: {\n      type: Number,\n      default: 100\n    },\n    token: {\n      type: String,\n      default: ''\n    },\n    domain: {\n      type: String,\n      default: ''\n    },\n    multiple: {\n      type: Boolean,\n      default: false\n    },\n    length: {\n      type: Number,\n      default: 9\n    },\n    isQiniu: {\n      type: Boolean,\n      default: false\n    },\n    isDelete: {\n      type: Boolean,\n      default: false\n    },\n    min: {\n      type: Number,\n      default: 0\n    },\n    meitu: {\n      type: Boolean,\n      default: false\n    },\n    isEdit: {\n      type: Boolean,\n      default: false\n    },\n    action: {\n      type: String,\n      default: ''\n    },\n    disabled: {\n      type: Boolean,\n      default: false\n    }\n  },\n  data: function data() {\n    return {\n      fileList: this.value.map(function (item) {\n        return {\n          key: item.key ? item.key : new Date().getTime() + '_' + Math.ceil(Math.random() * 99999),\n          url: item.url,\n          percent: item.percent ? item.percent : 100,\n          status: item.status ? item.status : 'success'\n        };\n      }),\n      viewer: null,\n      uploadId: 'upload_' + new Date().getTime(),\n      editIndex: -1,\n      meituIndex: -1\n    };\n  },\n  computed: {\n    miniWidth: function miniWidth() {\n      if (this.width > this.height) {\n        return this.height;\n      } else {\n        return this.width;\n      }\n    }\n  },\n  mounted: function mounted() {\n    this.$emit('input', this.fileList);\n  },\n  methods: {\n    handleChange: function handleChange() {\n      var _this2 = this;\n\n      console.log(this.$refs.uploadInput.files);\n      var files = this.$refs.uploadInput.files;\n\n      var _loop = function _loop(i) {\n        var file = files[i];\n        var reader = new FileReader();\n        var key = new Date().getTime() + '_' + Math.ceil(Math.random() * 99999);\n        reader.readAsDataURL(file);\n\n        reader.onload = function () {\n          if (_this2.editIndex >= 0) {\n            _this2.$set(_this2.fileList, _this2.editIndex, {\n              key: key,\n              url: reader.result,\n              percent: 0,\n              status: 'uploading'\n            });\n\n            _this2.editIndex = -1;\n          } else {\n            _this2.fileList.push({\n              key: key,\n              url: reader.result,\n              percent: 0,\n              status: 'uploading'\n            });\n          }\n\n          _this2.$nextTick(function () {\n            if (_this2.isQiniu) {\n              _this2.uplaodAction2(reader.result, file, key);\n            } else {\n              _this2.uplaodAction(reader.result, file, key);\n            }\n          });\n        };\n      };\n\n      for (var i = 0; i < files.length; i++) {\n        _loop(i);\n      }\n\n      this.$refs.uploadInput.value = [];\n    },\n    uplaodAction: function uplaodAction(res, file, key) {\n      var _this3 = this;\n\n      var changeIndex = this.fileList.findIndex(function (item) {\n        return item.key === key;\n      });\n      console.log(this.fileList.findIndex(function (item) {\n        return item.key === key;\n      }));\n      var xhr = new XMLHttpRequest();\n      var url = this.action;\n      xhr.open('POST', url, true); // xhr.setRequestHeader('Content-Type', 'multipart/form-data')\n\n      var formData = new FormData();\n      formData.append('file', file);\n      xhr.send(formData);\n\n      xhr.onreadystatechange = function () {\n        console.log(xhr);\n\n        if (xhr.readyState === 4) {\n          var resData = JSON.parse(xhr.response);\n\n          if (resData && resData.url) {\n            _this3.$set(_this3.fileList, _this3.fileList.findIndex(function (item) {\n              return item.key === key;\n            }), _objectSpread({}, _this3.fileList[_this3.fileList.findIndex(function (item) {\n              return item.key === key;\n            })], {\n              url: resData.url,\n              percent: 100\n            }));\n\n            setTimeout(function () {\n              _this3.$set(_this3.fileList, _this3.fileList.findIndex(function (item) {\n                return item.key === key;\n              }), _objectSpread({}, _this3.fileList[_this3.fileList.findIndex(function (item) {\n                return item.key === key;\n              })], {\n                status: 'success'\n              }));\n\n              _this3.$emit('input', _this3.fileList);\n            }, 200);\n          } else {\n            _this3.$set(_this3.fileList, _this3.fileList.findIndex(function (item) {\n              return item.key === key;\n            }), _objectSpread({}, _this3.fileList[_this3.fileList.findIndex(function (item) {\n              return item.key === key;\n            })], {\n              status: 'error'\n            }));\n\n            _this3.fileList.splice(_this3.fileList.findIndex(function (item) {\n              return item.key === key;\n            }), 1);\n          }\n        }\n      };\n\n      xhr.onprogress = function (res) {\n        console.log('progress', res);\n\n        if (res.total && res.loaded) {\n          _this3.$set(_this3.fileList[_this3.fileList.findIndex(function (item) {\n            return item.key === key;\n          })], 'percent', res.loaded / res.total * 100);\n        }\n      };\n    },\n    uplaodAction2: function uplaodAction2(res, file, key) {\n      var _this = this;\n\n      var observable = qiniu.upload(file, key, this.token, {\n        fname: key,\n        mimeType: []\n      }, {\n        useCdnDomain: true,\n        region: qiniu.region.z2\n      });\n      observable.subscribe({\n        next: function next(res) {\n          _this.$set(_this.fileList[_this.fileList.findIndex(function (item) {\n            return item.key === key;\n          })], 'percent', parseInt(res.total.percent));\n        },\n        error: function error(err) {\n          _this.$set(_this.fileList, _this.fileList.findIndex(function (item) {\n            return item.key === key;\n          }), _objectSpread({}, _this.fileList[_this.fileList.findIndex(function (item) {\n            return item.key === key;\n          })], {\n            status: 'error'\n          }));\n\n          _this.fileList.splice(_this.fileList.findIndex(function (item) {\n            return item.key === key;\n          }), 1);\n        },\n        complete: function complete(res) {\n          _this.$set(_this.fileList, _this.fileList.findIndex(function (item) {\n            return item.key === key;\n          }), _objectSpread({}, _this.fileList[_this.fileList.findIndex(function (item) {\n            return item.key === key;\n          })], {\n            url: _this.domain + res.key,\n            percent: 100\n          }));\n\n          setTimeout(function () {\n            _this.$set(_this.fileList, _this.fileList.findIndex(function (item) {\n              return item.key === key;\n            }), _objectSpread({}, _this.fileList[_this.fileList.findIndex(function (item) {\n              return item.key === key;\n            })], {\n              status: 'success'\n            }));\n\n            _this.$emit('input', _this.fileList);\n          }, 200);\n        }\n      });\n    },\n    handleRemove: function handleRemove(key) {\n      this.fileList.splice(this.fileList.findIndex(function (item) {\n        return item.key === key;\n      }), 1);\n    },\n    handleEdit: function handleEdit(key) {\n      this.editIndex = this.fileList.findIndex(function (item) {\n        return item.key === key;\n      });\n      this.$refs.uploadInput.click();\n    },\n    handleMeitu: function handleMeitu(key) {\n      this.$emit('on-meitu', this.fileList.findIndex(function (item) {\n        return item.key === key;\n      }));\n    },\n    handleAdd: function handleAdd() {\n      if (!this.disabled) {\n        this.editIndex = -1;\n        this.$refs.uploadInput.click();\n      }\n    },\n    handlePreviewFile: function handlePreviewFile(key) {\n      var _this4 = this;\n\n      this.viewer && this.viewer.destroy();\n      this.uploadId = 'upload_' + new Date().getTime();\n      console.log(this.viewer);\n      this.$nextTick(function () {\n        _this4.viewer = new Viewer(document.getElementById(_this4.uploadId));\n\n        _this4.viewer.view(_this4.fileList.findIndex(function (item) {\n          return item.key === key;\n        }));\n      });\n    }\n  },\n  watch: {\n    'fileList': {\n      deep: true,\n      handler: function handler(val) {// this.$emit('input', this.fileList)\n      }\n    }\n  }\n};",{"version":3,"sources":["index.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div class=\"fm-uplaod-container\"\n    :id=\"uploadId\"\n  >\n    <draggable class=\"drag-img-list\"\n      v-model=\"fileList\"\n      v-bind=\"{group: uploadId, ghostClass: 'ghost', animation: 200}\"\n      :no-transition-on-drag=\"true\"\n    >\n      <div \n        :id=\"item.key\"\n        :style=\"{width: width+'px', height: height+'px'}\"\n        :class=\"{uploading: item.status=='uploading', 'is-success': item.status=='success', 'is-diabled': disabled}\"\n        class=\"upload-file\" v-for=\"(item) in fileList\" :key=\"item.key\">\n        <img :src=\"item.url\" />\n\n        <el-progress v-if=\"item.status=='uploading'\" :width=\"miniWidth*0.9\" class=\"upload-progress\" type=\"circle\" :percentage=\"item.percent\"></el-progress>\n\n        <label class=\"item-status\" v-if=\"item.status=='success'\">\n          <i class=\"el-icon-upload-success el-icon-check\"></i>\n        </label>\n\n        <div class=\"uplaod-action\" :style=\"{height: miniWidth / 4 + 'px'}\" v-if=\"!disabled\">\n          <i class=\"iconfont icon-tupianyulan\" title=\"预览\" @click=\"handlePreviewFile(item.key)\" :style=\"{'font-size': miniWidth/8+'px'}\"></i>\n          <i v-if=\"isEdit\" class=\"iconfont icon-sync1\" title=\"替换\" @click=\"handleEdit(item.key)\" :style=\"{'font-size': miniWidth/8+'px'}\"></i>\n          <i v-if=\"isDelete && fileList.length > min\" class=\"iconfont icon-delete\" title=\"删除\" @click=\"handleRemove(item.key)\" :style=\"{'font-size': miniWidth/8+'px'}\"></i>\n        </div>\n      </div>\n    </draggable>\n\n    <div class=\"el-upload el-upload--picture-card\"\n      :class=\"{'is-disabled': disabled}\"\n      v-show=\"(!isQiniu || (isQiniu && token)) && fileList.length < length\"\n      :style=\"{width: width+'px', height: height+'px'}\"\n      @click.self=\"handleAdd\"\n    >\n      <i class=\"el-icon-plus\" @click.self=\"handleAdd\" :style=\"{fontSize:miniWidth/4+'px',marginTop: (-miniWidth/8)+'px', marginLeft: (-miniWidth/8)+'px'}\"></i>\n      <input accept=\"image/*\" v-if=\"multiple\"  multiple ref=\"uploadInput\" @change=\"handleChange\" type=\"file\" :style=\"{width: 0, height: 0}\" name=\"file\" class=\"el-upload__input upload-input\">\n      <input accept=\"image/*\" v-else ref=\"uploadInput\" @change=\"handleChange\" type=\"file\" :style=\"{width:0, height: 0}\" name=\"file\" class=\"el-upload__input upload-input\">\n    </div>\n  </div>\n</template>\n\n<script>\nimport Viewer from 'viewerjs'\nimport Draggable from 'vuedraggable'\nimport * as qiniu from 'qiniu-js'\nrequire('viewerjs/dist/viewer.css')\nexport default {\n  components: {\n    Draggable\n  },\n  props: {\n    value: {\n      type: Array,\n      default: () => []\n    },\n    width: {\n      type: Number,\n      default: 100\n    },\n    height: {\n      type: Number,\n      default: 100\n    },\n    token: {\n      type: String,\n      default: ''\n    },\n    domain: {\n      type: String,\n      default: ''\n    },\n    multiple: {\n      type: Boolean,\n      default: false\n    },\n    length: {\n      type: Number,\n      default: 9\n    },\n    isQiniu: {\n      type: Boolean,\n      default: false\n    },\n    isDelete: {\n      type: Boolean,\n      default: false\n    },\n    min: {\n      type: Number,\n      default: 0\n    },\n    meitu: {\n      type: Boolean,\n      default: false\n    },\n    isEdit: {\n      type: Boolean,\n      default: false\n    },\n    action: {\n      type: String,\n      default: ''\n    },\n    disabled: {\n      type: Boolean,\n      default: false\n    }\n  },\n  data () {\n    return {\n      fileList: this.value.map(item => {\n        return {\n          key: item.key ? item.key : (new Date().getTime()) + '_' + Math.ceil(Math.random() * 99999),\n          url: item.url,\n          percent: item.percent ? item.percent : 100,\n          status: item.status ? item.status : 'success'\n        }\n      }),\n      viewer: null,\n      uploadId: 'upload_' + new Date().getTime(),\n      editIndex: -1,\n      meituIndex: -1,\n    }\n  },\n  computed: {\n    miniWidth () {\n      if (this.width > this.height) {\n        return this.height\n      } else {\n        return this.width\n      }\n    }\n  },\n  mounted () {\n    this.$emit('input', this.fileList)\n  },\n  methods: {\n    handleChange () {\n      console.log(this.$refs.uploadInput.files)\n      const files = this.$refs.uploadInput.files\n      \n      for (let i = 0; i < files.length; i++) {\n        const file = files[i]\n        const reader = new FileReader()\n        const key = (new Date().getTime()) + '_' + Math.ceil(Math.random() * 99999)\n        reader.readAsDataURL(file)\n        reader.onload = () => {\n          if (this.editIndex >= 0) {\n\n            this.$set(this.fileList, this.editIndex, {\n              key,\n              url: reader.result,\n              percent: 0,\n              status: 'uploading'\n            })\n\n            this.editIndex = -1\n          } else {\n            this.fileList.push({\n              key,\n              url: reader.result,\n              percent: 0,\n              status: 'uploading'\n            })\n          }\n\n          this.$nextTick(() => {\n            if (this.isQiniu) {\n              this.uplaodAction2(reader.result, file, key)\n            } else {\n              this.uplaodAction(reader.result, file, key)\n            }\n          })\n        }\n      }\n      this.$refs.uploadInput.value = []\n    }, \n    uplaodAction (res, file, key) {\n      let changeIndex = this.fileList.findIndex(item => item.key === key)\n      console.log(this.fileList.findIndex(item => item.key === key))\n      const xhr = new XMLHttpRequest()\n      \n      const url = this.action\n      xhr.open('POST', url, true)\n      // xhr.setRequestHeader('Content-Type', 'multipart/form-data')\n\n      let formData = new FormData()\n      formData.append('file', file)\n\n      xhr.send(formData)\n      xhr.onreadystatechange = () => {\n        console.log(xhr)\n        if (xhr.readyState === 4) {\n          \n          let resData = JSON.parse(xhr.response)\n          if (resData && resData.url) {\n            this.$set(this.fileList, this.fileList.findIndex(item => item.key === key), {\n              ...this.fileList[this.fileList.findIndex(item => item.key === key)],\n              url: resData.url,\n              percent: 100\n            })\n            setTimeout(() => {\n              this.$set(this.fileList, this.fileList.findIndex(item => item.key === key), {\n                ...this.fileList[this.fileList.findIndex(item => item.key === key)],\n                status: 'success'\n              })\n              this.$emit('input', this.fileList)\n            }, 200)\n          } else {\n            this.$set(this.fileList, this.fileList.findIndex(item => item.key === key), {\n              ...this.fileList[this.fileList.findIndex(item => item.key === key)],\n              status: 'error'\n            })\n            this.fileList.splice(this.fileList.findIndex(item => item.key === key), 1)\n          }\n        }\n      }\n      xhr.onprogress = (res) => {\n        console.log('progress', res)\n        if (res.total && res.loaded) {\n          this.$set(this.fileList[this.fileList.findIndex(item => item.key === key)], 'percent', res.loaded/res.total*100)\n        }\n      }\n    },\n    uplaodAction2 (res, file, key) {\n      const _this = this\n      const observable = qiniu.upload(file, key, this.token, {\n        fname: key,\n        mimeType: []\n      }, {\n        useCdnDomain: true,\n        region: qiniu.region.z2\n      })\n      observable.subscribe({\n        next (res) {\n          _this.$set(_this.fileList[_this.fileList.findIndex(item => item.key === key)], 'percent', parseInt(res.total.percent))\n          \n        },\n        error (err) {\n          _this.$set(_this.fileList, _this.fileList.findIndex(item => item.key === key), {\n            ..._this.fileList[_this.fileList.findIndex(item => item.key === key)],\n            status: 'error'\n          })\n          _this.fileList.splice(_this.fileList.findIndex(item => item.key === key), 1)\n        },\n        complete (res) {\n          _this.$set(_this.fileList, _this.fileList.findIndex(item => item.key === key), {\n            ..._this.fileList[_this.fileList.findIndex(item => item.key === key)],\n            url: _this.domain + res.key,\n            percent: 100\n          })\n          setTimeout(() => {\n            _this.$set(_this.fileList, _this.fileList.findIndex(item => item.key === key), {\n              ..._this.fileList[_this.fileList.findIndex(item => item.key === key)],\n              status: 'success'\n            })\n            _this.$emit('input', _this.fileList)\n          }, 200)\n        }\n      })\n    },\n    handleRemove (key) {\n      this.fileList.splice(this.fileList.findIndex(item => item.key === key), 1)\n    },\n    handleEdit (key) {\n      \n      this.editIndex = this.fileList.findIndex(item => item.key === key)\n      \n      this.$refs.uploadInput.click()\n    },\n    handleMeitu (key) {\n\n      this.$emit('on-meitu', this.fileList.findIndex(item => item.key === key))\n    },\n    handleAdd () {\n      if (!this.disabled) {\n        this.editIndex = -1\n        this.$refs.uploadInput.click()\n      }\n    },\n    handlePreviewFile (key) {\n      this.viewer && this.viewer.destroy()\n      this.uploadId = 'upload_' + new Date().getTime()\n      \n      console.log(this.viewer)\n      this.$nextTick(() => {\n        this.viewer = new Viewer(document.getElementById(this.uploadId))\n        this.viewer.view(this.fileList.findIndex(item => item.key === key))\n      })\n    }\n  },\n  watch: {\n    'fileList': {\n      deep: true,\n      handler (val) {\n        // this.$emit('input', this.fileList)\n      }\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\">\n.fm-uplaod-container{\n  .is-disabled{\n    position: relative;\n\n    &::after{\n      position: absolute;\n      top: 0;\n      bottom: 0;\n      left: 0;\n      right: 0;\n      // background: rgba(0,0,0,.1);\n      content: '';\n      display: block;\n      cursor:not-allowed;\n    }\n  }\n\n  .upload-file{\n    margin: 0 10px 10px 0;\n    display: inline-flex;\n    justify-content: center;\n    align-items: center;\n    // background: #fff;\n    overflow: hidden;\n    background-color: #fff;\n    border: 1px solid #c0ccda;\n    border-radius: 6px;\n    box-sizing: border-box;\n    position: relative;\n    vertical-align: top;\n    &:hover{\n      .uplaod-action{\n        display: flex;\n      }\n    }\n    .uplaod-action{\n      position: absolute;\n      // top: 0;\n      // height: 30px;\n      bottom: 0;\n      left: 0;\n      right: 0;\n      background: rgba(0,0,0,0.6);\n      display: none;\n      justify-content: center;\n      align-items: center;\n      i{\n        color: #fff;\n        cursor: pointer;\n        margin: 0 5px;\n      }\n    }\n    &.is-success{\n      .item-status{\n        position: absolute;\n        right: -15px;\n        top: -6px;\n        width: 40px;\n        height: 24px;\n        background: #13ce66;\n        text-align: center;\n        transform: rotate(45deg);\n        box-shadow: 0 0 1pc 1px rgba(0,0,0,.2);\n        &>i{\n          font-size: 12px;\n          margin-top: 11px;\n          color: #fff;\n          transform: rotate(-45deg);\n        }\n      }\n    }\n    &.uploading{\n      &:before{\n        display: block;\n        content: '';\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0,0,0,0.3);\n      }\n    }\n    .upload-progress{\n      position: absolute;\n      .el-progress__text{\n        color: #fff;\n        font-size: 16px !important;\n      }\n    }\n    img{\n      max-width: 100%;\n      max-height: 100%;\n      vertical-align: middle;\n    }\n  }\n  .el-upload--picture-card{\n    position: relative;\n    overflow: hidden;\n    .el-icon-plus{\n      position: absolute;\n      top: 50%;\n      left: 50%;\n    }\n  }\n  .upload-input{\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    display: block;\n    opacity: 0;\n    cursor: pointer;\n  }\n\n  .drag-img-list{\n    display: inline;\n\n    .ghost{\n      position: relative;\n      &::after {\n        width: 100%;\n        height: 100%;\n        display: block;\n        content: '';\n        background: #fbfdff;\n        position: absolute;\n        top: 0;\n        bottom: 0;\n        left: 0;\n        right: 0;\n        border: 1px dashed #3bb3c2;\n      }\n    }\n\n    &>div{\n      cursor: move;\n    }\n  }\n}\n\n.viewer-container{\n  z-index: 9999 !important;\n}\n</style>\n"],"sourceRoot":"src/components/Upload"}]}